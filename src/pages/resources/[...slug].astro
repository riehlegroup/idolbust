---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { formatDate } from "@/utils/blog";
import { getPublishedEntries } from "@/utils/content";
import { getResourceSlug, type ResourceEntry } from "@/utils/resources";
import { withBase } from "@/utils/with-base";
import { getCollection, render } from "astro:content";

interface ResourcePageProps {
  resource: ResourceEntry;
  relatedResources: ResourceEntry[];
}

export async function getStaticPaths() {
  const publishedResources: ResourceEntry[] = getPublishedEntries(
    await getCollection("resources")
  );
  const resourcesBySlug = new Map<string, ResourceEntry>(
    publishedResources.map((resource) => [getResourceSlug(resource), resource])
  );

  return publishedResources.map((resource) => {
    const relatedResources = resource.data.related
      .map((relatedSlug: string) => resourcesBySlug.get(relatedSlug))
      .filter((related: ResourceEntry | undefined): related is ResourceEntry =>
        Boolean(related)
      );

    return {
      params: { slug: getResourceSlug(resource) },
      props: { resource, relatedResources },
    };
  });
}

const { resource, relatedResources } = Astro.props as ResourcePageProps;
const { Content } = await render(resource);
const effectiveDate = resource.data.updatedDate ?? resource.data.pubDate;
const pageTitle = resource.data.seoTitle ?? resource.data.title;
const pageDescription = resource.data.seoDescription ?? resource.data.description;
const pageImage = resource.data.ogImage ?? resource.data.heroImage;
---

<BaseLayout title={pageTitle} description={pageDescription} image={pageImage}>
  <article class="prose prose-secondary mx-auto max-w-3xl px-4 py-12 sm:px-6 lg:px-8">
    <header class="mb-8 not-prose">
      <p class="mb-3 inline-flex rounded-full bg-secondary-100 px-3 py-1 text-sm font-medium text-secondary-700">
        {resource.data.category}
      </p>
      <h1 class="text-4xl font-bold text-secondary-900">{resource.data.title}</h1>
      <div class="mt-4 flex flex-wrap items-center gap-2 text-secondary-600">
        <time datetime={effectiveDate.toISOString()}>{formatDate(effectiveDate)}</time>
        {resource.data.updatedDate && <span>Updated</span>}
      </div>
      {resource.data.tags.length > 0 && (
        <div class="mt-4 flex flex-wrap gap-2">
          {resource.data.tags.map((tag: string) => (
            <span class="rounded-full bg-primary-50 px-3 py-1 text-sm text-primary-700">#{tag}</span>
          ))}
        </div>
      )}
      {resource.data.heroImage && (
        <img
          src={resource.data.heroImage}
          alt={resource.data.title}
          class="mt-6 aspect-video w-full rounded-lg object-cover"
          width="1200"
          height="675"
          loading="lazy"
        />
      )}
    </header>

    <Content />

    {(resource.data.canonical || relatedResources.length > 0) && (
      <section class="mt-12 border-t border-secondary-200 pt-8 not-prose">
        {resource.data.canonical && (
          <p class="text-sm text-secondary-600">
            Canonical source:{" "}
            <a class="text-primary-700 hover:text-primary-800" href={resource.data.canonical} rel="noopener noreferrer">
              {resource.data.canonical}
            </a>
          </p>
        )}

        {relatedResources.length > 0 && (
          <>
            <h2 class="mt-6 text-xl font-semibold text-secondary-900">Related resources</h2>
            <ul class="mt-3 space-y-2 text-secondary-700">
              {relatedResources.map((relatedResource) => (
                <li>
                  <a
                    class="hover:text-primary-700"
                    href={withBase(`/resources/${getResourceSlug(relatedResource)}/`)}
                  >
                    {relatedResource.data.title}
                  </a>
                </li>
              ))}
            </ul>
          </>
        )}
      </section>
    )}
  </article>
</BaseLayout>
