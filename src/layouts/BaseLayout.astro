---
import { BRAND_CONFIG, formatPageTitle } from '@/config/brand';
import '@/styles/global.css';
import { withBase } from '@/utils/with-base';

export interface Props {
  title: string;
  description?: string;
  image?: string;
  twitterSite?: string;
}

const { title, description, image, twitterSite } = Astro.props;
const { identity, organization, seo, theme } = BRAND_CONFIG;
const quoteFontFamily = (fontFamily: string): string => {
  const trimmedFontFamily = fontFamily.trim();
  const unquotedFontFamily = trimmedFontFamily.replace(/^['"]+|['"]+$/g, '');

  if (!/\s/.test(unquotedFontFamily)) {
    return unquotedFontFamily;
  }

  return `"${unquotedFontFamily}"`;
};

const formatFontStack = (fonts: readonly string[] | undefined, fallback: readonly string[]): string => {
  return (fonts ?? fallback).map(quoteFontFamily).join(', ');
};

const sansFontStack = formatFontStack(theme.fonts?.sans, ['Inter', 'system-ui', 'sans-serif']);
const monoFontStack = formatFontStack(theme.fonts?.mono, ['JetBrains Mono', 'monospace']);
const fullTitle = formatPageTitle(title);
const pageDescription = description ?? seo.defaultDescription;
const canonicalBase = Astro.site?.href ?? identity.siteUrl;
const canonicalUrl = new URL(Astro.url.pathname, canonicalBase).href;
const siteUrl = new URL(withBase('/'), canonicalBase).href;
const ogImageUrl = new URL(withBase(image ?? identity.defaultOgImagePath), canonicalBase).href;
const logoUrl = new URL(withBase(identity.logoPath), canonicalBase).href;
const brandVars = [
  ...Object.entries(theme.primary).map(([shade, value]) => `--color-primary-${shade}: ${value};`),
  ...Object.entries(theme.secondary).map(([shade, value]) => `--color-secondary-${shade}: ${value};`),
  `--font-sans: ${sansFontStack};`,
  `--font-mono: ${monoFontStack};`,
  `--color-theme: ${theme.themeColor};`,
].join(' ');
const rootStyles = brandVars;
const organizationJsonLd: Record<string, unknown> = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: organization.name,
  url: siteUrl,
  logo: {
    '@type': 'ImageObject',
    url: logoUrl,
  },
  sameAs: organization.socialProfiles,
};

if (organization.legalName) {
  organizationJsonLd['legalName'] = organization.legalName;
}

if (organization.address) {
  organizationJsonLd['address'] = {
    '@type': 'PostalAddress',
    ...organization.address,
  };
}

const jsonLd = [
  organizationJsonLd,
  {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: identity.siteName,
    url: siteUrl,
    description: pageDescription,
    inLanguage: identity.language,
  },
  {
    '@context': 'https://schema.org',
    '@type': 'WebPage',
    name: fullTitle,
    url: canonicalUrl,
    description: pageDescription,
    inLanguage: identity.language,
    primaryImageOfPage: {
      '@type': 'ImageObject',
      url: ogImageUrl,
    },
  },
];
const jsonLdString = JSON.stringify(jsonLd).replace(/<\/script/gi, '<\\/script');
---

<!doctype html>
<html lang={identity.language} class="h-full" style={rootStyles}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={pageDescription} />
    <meta name="robots" content={seo.robots} />
    <meta name="generator" content={Astro.generator} />

    <link rel="icon" type="image/svg+xml" href={withBase(identity.faviconPath)} />
    <link rel="apple-touch-icon" sizes="180x180" href={withBase(identity.appleTouchIconPath)} />
    <link rel="manifest" href={withBase(identity.manifestPath)} />
    <meta name="theme-color" content={theme.themeColor} />
    <link rel="canonical" href={canonicalUrl} />

    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={identity.siteName} />
    <meta property="og:locale" content={identity.locale} />
    <meta name="twitter:card" content={seo.twitterCard} />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:url" content={canonicalUrl} />
    {(twitterSite ?? seo.twitterSite) && <meta name="twitter:site" content={twitterSite ?? seo.twitterSite} />}

    <script type="application/ld+json" is:inline set:html={jsonLdString}></script>

    <title>{fullTitle}</title>
  </head>
  <body class="flex h-full flex-col overflow-hidden bg-white text-secondary-900 antialiased">
    <header class="sticky top-0 z-50 border-b border-secondary-200 bg-white/80 backdrop-blur-sm">
      <nav class="mx-auto flex max-w-7xl items-center justify-between px-4 py-4 sm:px-6 lg:px-8">
        <a href={withBase('/')} class="text-xl font-bold text-primary-600 hover:text-primary-700">
          {identity.siteName}
        </a>
        <ul class="flex items-center gap-6 text-sm font-medium">
          <li><a href={withBase('/about')} class="hover:text-primary-600">About</a></li>
          <li><a href={withBase('/blog')} class="hover:text-primary-600">Blog</a></li>
          <li><a href={withBase('/resources')} class="hover:text-primary-600">Resources</a></li>
        </ul>
      </nav>
    </header>

    <main class="scroll-area flex-1 overflow-y-auto">
      <slot />
    </main>

    <footer class="border-t border-secondary-200 bg-secondary-50 py-8">
      <div class="mx-auto max-w-7xl px-4 text-center text-sm text-secondary-600 sm:px-6 lg:px-8">
        <p>&copy; {new Date().getFullYear()} {identity.siteName} Licensed under AGPL-3.0.</p>
      </div>
    </footer>
  </body>
</html>
